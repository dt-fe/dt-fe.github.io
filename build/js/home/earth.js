function webgl_detect(a){if(window.WebGLRenderingContext){for(var b=document.createElement("canvas"),c=["webgl","experimental-webgl","moz-webgl","webkit-3d"],d=!1,e=0;e<4;e++)try{if(d=b.getContext(c[e]),d&&"function"==typeof d.getParameter)return!a||{name:c[e],gl:d}}catch(a){}return!1}return!1}function init(){initTHREE(),addEarth(),addAtmosphere(),addSun(),addBars(),animate()}function initTHREE(){mContainer=document.getElementById("three-container"),mRenderer=new THREE.WebGLRenderer({antialias:!0,alpha:!0}),mRenderer.setSize(mContainer.offsetWidth,mContainer.offsetHeight),mRenderer.setClearColor("#000000",0),mRenderer.shadowMap.enabled=!0,mRenderer.shadowMap.type=THREE.PCFSoftShadowMap,mContainer.appendChild(mRenderer.domElement),mCamera=new THREE.PerspectiveCamera(60,mContainer.offsetWidth/mContainer.offsetHeight,.1,5e3),mCamera.position.z=2,mCamera.position.y=2,mCamera.position.x=2,mCamera.lookAt({x:0,y:0,z:0}),mScene=new THREE.Scene;new THREE.AxisHelper(1500)}function addBars(){createBars()}function createBars(){for(var a,b,c,d,e,f=1.05,g=new THREE.Geometry,h=new THREE.Color,i=0;i<mData.length/3;i++){a=mData[3*i+0],b=mData[3*i+1],c=mData[3*i+2],c>.3&&(c/=4);var j=new THREE.BoxGeometry(.01,.01,.6);j.applyMatrix((new THREE.Matrix4).makeTranslation(0,0,-.3));var k=new THREE.Mesh(j);d=(90-a)*Math.PI/180,e=(180-b)*Math.PI/180,k.position.x=f*Math.sin(d)*Math.cos(e),k.position.y=f*Math.cos(d),k.position.z=f*Math.sin(d)*Math.sin(e),k.lookAt(mEarth.position.normalize()),k.scale.z=Math.max(c,.01),k.scale.y=.3,k.scale.x=.3,k.updateMatrix(),h.set(1470463);for(var l=0;l<k.geometry.faces.length;l++)k.geometry.faces[l].color=h;g.merge(k.geometry,k.matrix)}mPoints=new THREE.Mesh(g,new THREE.MeshLambertMaterial({opacity:.8,transparent:!0,color:16777215,vertexColors:THREE.FaceColors})),mScene.add(mPoints)}function addSun(){var a=new THREE.AmbientLight(16777215,.8),b=new THREE.DirectionalLight(16777215,.3);b.name="sun",b.position.set(-4,0,0),b.castShadow=!0,b.shadow.camera.near=1,b.shadow.camera.far=5,b.shadow.camera.fov=30,b.shadow.camera.left=-1,b.shadow.camera.right=1,b.shadow.camera.top=1,b.shadow.camera.bottom=-1,b.shadowCameraHelper=new THREE.CameraHelper(b.shadow.camera),mScene.add(a),mScene.add(b)}function addAtmosphere(){var a=mEarth.geometry.clone(),b=Shader.atmosphere,c=THREE.UniformsUtils.clone(b.uniforms),d=new THREE.ShaderMaterial({uniforms:c,vertexShader:b.vertexShader,fragmentShader:b.fragmentShader,side:THREE.BackSide,blending:THREE.AdditiveBlending,transparent:!0}),e=new THREE.Mesh(a,d);e.scale.set(1.12,1.12,1.12),mScene.add(e)}function addEarth(){var a=new THREE.SphereGeometry(1,64,32),b=new THREE.MeshPhongMaterial({map:mLoader.load("https://img.alicdn.com/tps/TB1IdZwNXXXXXcFaXXXXXXXXXXX-2048-1024.jpg"),bumpScale:.02,specular:new THREE.Color(16777215),shininess:4});earth=new THREE.Mesh(a,b),earth.name="earth",earth.castShadow=!0,earth.receiveShadow=!1,mEarth=earth,mEarth.rotation.y=Math.PI,mScene.add(earth)}function addScan(){function a(){var a=c.percent*Math.PI;changeWave(1.08,a,c.percent)}function b(){mCloud.rotation.y=Math.PI*Math.random()}addWave(1.08,0);var c={percent:0};TweenMax.to(c,5,{percent:1,repeat:1/0,onRepeat:b,onUpdate:a,repeatDelay:.5,ease:Linear.easeOut})}function addWave(a,b){for(var c=20,d=50,e=d*c,f=new THREE.BufferGeometry,g=new Float32Array(3*e),h=new Float32Array(3*e),i=new Float32Array(e),j=new Uint32Array(6*d*(c-1)),k=0,l=0;l<c-1;l++)for(var m=0;m<d;m++)j[k++]=l*d+m,j[k++]=l*d+(m+1)%d,j[k++]=(l+1)*d+m,j[k++]=l*d+(m+1)%d,j[k++]=(l+1)*d+(m+1)%d,j[k++]=(l+1)*d+m;for(var n=new THREE.Color(10670591),l=0;l<c;l++)for(var m=0;m<d;m++)h[3*(l*d+m)+0]=n.r,h[3*(l*d+m)+1]=n.g,h[3*(l*d+m)+2]=n.b,i[l*d+m]=l+1;f.setIndex(new THREE.BufferAttribute(j,1)),f.addAttribute("position",new THREE.BufferAttribute(g,3)),f.addAttribute("customColor",new THREE.BufferAttribute(h,3)),f.addAttribute("level",new THREE.BufferAttribute(i,1));var o=new THREE.ShaderMaterial({uniforms:{totLevel:{type:"f",value:c},percent:{type:"f",value:0}},transparent:!0,vertexShader:Shader.scan.vertexShader,fragmentShader:Shader.scan.fragmentShader}),p=new THREE.Mesh(f,o);mCloud=p,mScene.add(p)}function changeWave(a,b,c){for(var d=20,e=50,f=Math.PI/6,g=mCloud.geometry,h=mCloud.material,i=g.attributes.position.array,j=1.05*a,k=0;k<d;k++)for(var l=Math.max(0,b-f*k/d),m=j*Math.sin(l),n=j*Math.cos(l),o=0;o<e;o++){var p=o/e*Math.PI*2,q=m*Math.cos(p),r=m*Math.sin(p);i[3*(k*e+o)+0]=n,i[3*(k*e+o)+1]=q,i[3*(k*e+o)+2]=r}g.attributes.position.needsUpdate=!0,h.uniforms.percent.value=c}function animate(){mRenderer.render(mScene,mCamera),earth.rotation.y+=.001,mPoints.rotation.y+=.001,requestAnimationFrame(animate)}var Shader={scan:{vertexShader:["attribute vec3 customColor;","attribute float level;","varying vec3 v_color;","varying float v_level;","void main() {","v_color = customColor;","v_level = level;","vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);","gl_Position = projectionMatrix * mvPosition;","}"].join("\n"),fragmentShader:["uniform float totLevel;","uniform float percent;","varying vec3 v_color;","varying float v_level;","void main() {","float opacity = (0.8 - percent) * (1.0 - v_level / totLevel);","gl_FragColor = vec4(v_color, opacity);","}"].join("\n")},atmosphere:{uniforms:{},vertexShader:["varying vec3 vNormal;","void main() {","vNormal = normalize( normalMatrix * normal );","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["varying vec3 vNormal;","void main() {","float intensity = pow( 0.8 - dot( vNormal, vec3( 0, 0, 1.0 ) ), 12.0 );","gl_FragColor = vec4( 1.0, 1.0, 1.0, 0.3 ) * intensity;","}"].join("\n")}},mScene,mContainer,mRenderer,mCamera,mControls,mFlightsPathLines,mPlane,mCloud,mData,mPoints,mEarth,earth,mLoader=new THREE.TextureLoader;mLoader.crossOrigin=!0,window.onload=function(){webgl_detect()&&(init(),$(".3d-earth-img").hide())};