function init(){initTHREE(),addSystem(),addSun(),addEarth(),addFlights(),addPlanes(),animate()}function initTHREE(){mContainer=document.getElementById("three-container"),mRenderer=new THREE.WebGLRenderer({antialias:!0,alpha:!0}),mRenderer.setSize(mContainer.offsetWidth,mContainer.offsetHeight),mRenderer.setClearColor("#000000",0),mRenderer.shadowMap.enabled=!0,mRenderer.shadowMap.type=THREE.PCFSoftShadowMap,mContainer.appendChild(mRenderer.domElement),mCamera=new THREE.PerspectiveCamera(60,mContainer.offsetWidth/mContainer.offsetHeight,.1,5e3),mCamera.position.z=2,mCamera.position.y=2,mCamera.position.x=2,mCamera.lookAt({x:0,y:0,z:0}),mScene=new THREE.Scene}function addSystem(){mSystem=new THREE.Object3D,mSystem.name="system",mScene.add(mSystem)}function addSun(){var a=new THREE.AmbientLight(16777215,1),b=new THREE.SpotLight(16777215,.8);b.name="sun",b.position.set(-4,0,0),b.castShadow=!0,b.shadow.camera.near=1,b.shadow.camera.far=5,b.shadow.camera.fov=30,b.shadow.camera.left=-1,b.shadow.camera.right=1,b.shadow.camera.top=1,b.shadow.camera.bottom=-1,mSystem.add(a),mSystem.add(b)}function addEarth(){var a=new THREE.SphereGeometry(1.25,64,32),b=new THREE.MeshPhongMaterial({map:mLoader.load("https://img.alicdn.com/tps/TB1IdZwNXXXXXcFaXXXXXXXXXXX-2048-1024.jpg"),bumpScale:.02,shininess:4});earth=new THREE.Mesh(a,b),earth.name="earth",earth.castShadow=!0,earth.receiveShadow=!1,mSystem.add(earth)}function addFlights(){setupFlightsPathSplines(1.25),setupFlightsPathLines()}function setupFlightsPathSplines(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q=flights.length;for(b=0;b<q;b++){for(e=flights[b][0],f=flights[b][1],g=flights[b][2],h=flights[b][3],c=latlongDistance(e,f,g,h),d=.02+.1*c,mMaxAltitudes[b]=d,mDistances[b]=c,i=8,j=[],k=0;k<i+1;k++)l=180*k/i,m=a+Math.sin(l*Math.PI/180)*d,n=latlongTween(e,f,g,h,k/i),o=ll2xyz(n.latitude,n.longitude,m),j.push(new THREE.Vector3(o.x,o.y,o.z));p=new THREE.CatmullRomCurve3(j),mFlightsPathSplines.push(p),setFlightTimes(b)}}function setupFlightsPathLines(){var a,b,c,d,e=new THREE.Color,f=flights.length,g=32,h=new THREE.BufferGeometry,i=new THREE.LineBasicMaterial({color:16777215,vertexColors:THREE.VertexColors,transparent:!0,opacity:mFlightsPathLinesOpacity,depthTest:!0,depthWrite:!1,linewidth:1}),j=new Float32Array(f*g*3*2),k=new Float32Array(f*g*3*2);for(a=0;a<f;a++){var l=mFlightsPathSplines[a].getPoints(32);for(b=0;b<g;b++)c=b/(g-1),d=3*(a*g+b),j[d+0]=l[b].x,j[d+1]=l[b].y,j[d+2]=l[b].z,e.set(1470463),k[d+0]=e.r,k[d+1]=e.g,k[d+2]=e.b}h.addAttribute("position",new THREE.BufferAttribute(j,3)),h.addAttribute("color",new THREE.BufferAttribute(k,3)),mFlightsPathLines=new THREE.Line(h,i),mSystem.add(mFlightsPathLines)}function setFlightTimes(a){var b=flights[a],c=latlongDistance(b[0],b[1],b[2],b[3]),d=Date.now()+Math.floor(1e3*Math.random()*20),e=Math.floor(1e3*c*80);e*=.8+Math.random(),mFlightsStartTimes[a]=d,mFlightsEndTimes[a]=d+e}function latlongDistance(a,b,c,d){var e=a*Math.PI/180,f=c*Math.PI/180,g=(c-a)*Math.PI/180,h=(d-b)*Math.PI/180,i=Math.sin(g/2)*Math.sin(g/2)+Math.cos(e)*Math.cos(f)*Math.sin(h/2)*Math.sin(h/2),j=2*Math.atan2(Math.sqrt(i),Math.sqrt(1-i));return j}function latlongTween(a,b,c,d,e){a*=Math.PI/180,b*=Math.PI/180,c*=Math.PI/180,d*=Math.PI/180;var f=2*Math.asin(Math.sqrt(Math.pow(Math.sin((a-c)/2),2)+Math.cos(a)*Math.cos(c)*Math.pow(Math.sin((b-d)/2),2))),g=Math.sin((1-e)*f)/Math.sin(f),h=Math.sin(e*f)/Math.sin(f),i=g*Math.cos(a)*Math.cos(b)+h*Math.cos(c)*Math.cos(d),j=g*Math.cos(a)*Math.sin(b)+h*Math.cos(c)*Math.sin(d),k=g*Math.sin(a)+h*Math.sin(c),l=180*Math.atan2(k,Math.sqrt(Math.pow(i,2)+Math.pow(j,2)))/Math.PI,m=180*Math.atan2(j,i)/Math.PI;return{latitude:l,longitude:m}}function ll2xyz(a,b,c){var d=(90-a)*Math.PI/180,e=(360-b)*Math.PI/180;return{x:c*Math.sin(d)*Math.cos(e),y:c*Math.cos(d),z:c*Math.sin(d)*Math.sin(e)}}function addPlanes(){var a,b=flights.length,c=new THREE.BufferGeometry,d=new THREE.ShaderMaterial({vertexShader:Shader.vertexShader,fragmentShader:Shader.fragmentShader,uniforms:{map:{type:"t",value:mLoader.load("https://img.alicdn.com/tps/TB1f7ThNXXXXXcHXVXXXXXXXXXX-128-128.png")},size:{type:"f",value:.04},time:{type:"f",value:0},totTime:{type:"f",value:mTotTime}},depthTest:!0,depthWrite:!1,transparent:!0}),e=new Float32Array(3*b),f=new Float32Array(3*b),g=new Float32Array(4*b),h=new Float32Array(1*b),i=new Float32Array(1*b),j=new THREE.Color;for(a=0;a<b;a++){var k=mFlightsPathSplines[a].getPoint(.5);e[3*a+0]=k.x,e[3*a+1]=k.y,e[3*a+2]=k.z,g[4*a+0]=flights[a][0],g[4*a+1]=flights[a][1],g[4*a+2]=flights[a][2],g[4*a+3]=flights[a][3],h[a]=mMaxAltitudes[a],j.set(1470463),f[3*a+0]=j.r,f[3*a+1]=j.g,f[3*a+2]=j.b,i[a]=THREE.Math.randFloat(0,3e4)}c.addAttribute("position",new THREE.BufferAttribute(e,3)),c.addAttribute("customColor",new THREE.BufferAttribute(f,3)),c.addAttribute("latlong",new THREE.BufferAttribute(g,4)),c.addAttribute("altitude",new THREE.BufferAttribute(h,1)),c.addAttribute("delay",new THREE.BufferAttribute(i,1)),c.computeBoundingBox();var l=new THREE.Points(c,d);mPlane=l,mSystem.add(l)}function updatePlanesPosition(){var a,b=flights.length,c=Date.now(),d=(c-mStartTime)%3e4,e=mPlane.geometry.attributes.position.array;for(a=0;a<b;a++){var f=mFlightsPathSplines[a].getPoint((d+mFlightsDelayTimes[a]+3e4)/3e4);e[3*a+0]=f.x,e[3*a+1]=f.y,e[3*a+2]=f.z}mPlane.geometry.attributes.position.needsUpdate=!0}function animate(){mRenderer.render(mScene,mCamera),TWEEN.update(),earth.rotation.y+=.001,mPlane.rotation.y+=.001,mFlightsPathLines.rotation.y+=.001;var a=Date.now()%mTotTime;mPlane.material.uniforms.time.value=a,requestAnimationFrame(animate)}var Shader={vertexShader:["#define PI 3.14159265358979;","vec2 latlongTween(float latitudeA, float longitudeA, float latitudeB, float longitudeB, float tween) {","latitudeA  = radians(latitudeA);","longitudeA = radians(longitudeA);","latitudeB  = radians(latitudeB);","longitudeB = radians(longitudeB);","float d = 2.0 * asin( sqrt("," pow(( sin(( latitudeA - latitudeB ) / 2.0 )), 2.0 ) +","cos( latitudeA ) *","cos( latitudeB ) *","pow( sin(( longitudeA - longitudeB ) / 2.0 ), 2.0 )","));","float A = sin(( 1.0 - tween ) * d ) / sin( d );","float B = sin( tween * d ) / sin( d );","float x = A * cos( latitudeA ) * cos( longitudeA ) + B * cos( latitudeB ) * cos( longitudeB );","float y = A * cos( latitudeA ) * sin( longitudeA ) + B * cos( latitudeB ) * sin( longitudeB );","float z = A * sin( latitudeA ) + B * sin( latitudeB );","float latitude  = atan ( z, sqrt( pow( x, 2.0 ) + pow( y, 2.0 ))) * 180.0 / PI;","float longitude = atan( y, x ) * 180.0 / PI;","return vec2(latitude, longitude);","}","vec3 ll2xyz(float latitude, float longitude, float radius) {","float phi   = radians(  90.0 - latitude  ); //  * PI / 180.0;","float theta = radians( 360.0 - longitude ); // * PI / 180.0;","return vec3(radius * sin(phi) * cos(theta), radius * cos(phi), radius * sin(phi) * sin(theta));","}","uniform float size;","uniform float time;","uniform float totTime;","attribute vec4 latlong;","attribute float altitude;","attribute float delay;","attribute vec3 customColor;","varying vec3 v_color;","void main() {","v_color = customColor;","float ratio = mod(time + delay, 30000.0) / 30000.0;","vec2 ll = latlongTween(latlong.x, latlong.y, latlong.z, latlong.w, ratio);","float arcAngle = radians(ratio * 180.0);","float arcRadius = 1.25 + sin(arcAngle) * altitude;","vec3 pos = ll2xyz(ll.x, ll.y, arcRadius);","vec4 mvPosition = modelViewMatrix * vec4(pos, 1.0);","gl_PointSize = size * ( 300.0 / length( mvPosition.xyz ));","gl_Position = projectionMatrix * mvPosition;","}"].join("\n"),fragmentShader:["uniform sampler2D map;","varying vec3 v_color;","void main() {","gl_FragColor = vec4(v_color, 1.0 );","gl_FragColor = gl_FragColor * texture2D(map, gl_PointCoord);","}"].join("\n")},mScene,mContainer,mRenderer,mCamera,mSystem,mControls,mFlightsPathLines,mPlane,earth,mFlightsPathSplines=[],mFlightsStartTimes=[],mFlightsEndTimes=[],mFlightsDelayTimes=[],mFlightsPathLinesOpacity=.02,mLoader=new THREE.TextureLoader,mStartTime=Date.now(),mStartPoints=[],mEndPoints=[],mDistances=[],mMaxAltitudes=[],mTotTime=2e4;mLoader.crossOrigin=!0,THREE.DefaultLoadingManager.onProgress=function(a,b,c){b===c&&$(".static-earth").css("display","none")},window.onload=function(){init()};